<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- three.js as base library with model-viewer and model-viewer-effects must be loaded -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@^0.169.0/build/three.module.min.js"
      }
    }
  </script>
  <script type="module" src=" https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer-module.min.js "></script>
  <script type="module" src=" https://cdn.jsdelivr.net/npm/@google/model-viewer-effects/dist/model-viewer-effects.min.js "></script>


  <title>3D Model Viewer</title>
  <style type="text/css">
   model-viewer{
    height:1000px;
    width: 100%;
    background: #2b2a2a;

  }

  body { margin: 0; padding: 0; box-sizing: border-box; background: #2b2a2a;font-family: Causten-Regular, sans-serif;}

  #colorPicker{
    color:white;
    gap:1rem;
    font-family: Causten-Regular, sans-serif;;
    display:flex;
    flex-direction: column;
    font-size: 1.125rem;
    align-items: flex-start;

    padding: 1.875rem;
    border-radius: 1.25rem;
    border: 1px solid rgba(122, 122, 122, 0.70);
    background: linear-gradient(152deg, rgba(0, 0, 0, 0.40) 1.55%, rgba(0, 0, 0, 0.16) 97.37%);
    box-shadow: 233px 250px 96px 0 rgba(0, 0, 0, 0.00), 149px 160px 88px 0 rgba(0, 0, 0, 0.01), 84px 90px 74px 0 rgba(0, 0, 0, 0.05), 37px 40px 55px 0 rgba(0, 0, 0, 0.09), 9px 10px 30px 0 rgba(0, 0, 0, 0.10);
    backdrop-filter: blur(15px);
  }

  .action-control{
    color:white;
    gap:1rem;
    font-family: Causten-Regular, sans-serif;;
    display:flex;
    flex-direction: row;
    font-size: 1.125rem;
    align-items: flex-start;

    padding: 1.875rem;
    border-radius: 1.25rem;
    border: 1px solid rgba(122, 122, 122, 0.70);
    background: linear-gradient(152deg, rgba(0, 0, 0, 0.40) 1.55%, rgba(0, 0, 0, 0.16) 97.37%);
    box-shadow: 233px 250px 96px 0 rgba(0, 0, 0, 0.00), 149px 160px 88px 0 rgba(0, 0, 0, 0.01), 84px 90px 74px 0 rgba(0, 0, 0, 0.05), 37px 40px 55px 0 rgba(0, 0, 0, 0.09), 9px 10px 30px 0 rgba(0, 0, 0, 0.10);
    backdrop-filter: blur(15px);
  }

  #menu{
    display: flex;
    flex-direction: column;
    margin:4rem;
    align-items: flex-start;
    position:absolute;
    gap:0.625rem;
  }

  select{
    box-shadow: 1px 1px 2px #a0a7b8;
    border:0;
    padding:0.25rem;
    border-radius:0.4rem;
    font-family: Causten-Regular, sans-serif;;
    font-size: 1.2rem;
    width: 7rem;
  }

  .diffuseButton{
    color:white;
    display: flex;
    width: 22rem;
    padding: 0.375rem 0.5rem 0.375rem 1rem;
    justify-content: space-between;
    align-items: center;
    border-radius: 2rem;
    border: 1px solid #424242;
    background: linear-gradient(90deg, #424242 0%, rgba(66, 66, 66, 0.40) 100%);
  }

  input[type="color"]{
    border:none;
    outline: none;
    overflow:hidden;
    background:transparent;
    padding:0;
    border-radius: 50%;
    width: 3rem;
    height:3rem;
  }

  input[type="color"]::-moz-color-swatch{
    border:none;
  }




</style>
</head>

<body>
  <!-- model-viewer and script must be kept as is to guarantee correct visualisation -->
  <div class="wrapper">
    <model-viewer id="plane" skybox-height="1.5m" exposure="2" shadow-intensity="6" environment-image="Retail Store_sw_levels.hdr" camera-controls  camera-target="0 0 0" min-camera-orbit="auto auto 0.1m" max-camera-orbit="auto 93deg 35m" touch-action="pan-y" interaction-prompt="none" camera-orbit="40deg 70deg 15m"  src="KonfiBase12.glb" skybox-height="0.0m" ar alt="device 3D model" tone-mapping="agx">

<!--
      <div class="controls glass" id="diffuse-control">
        <div>
          <p>Farbe auswählen: </p>
          <select id="diffuse">
            <option value="#AF40FF">Rot</option>
            <option value="#0000ff">Blau</option>
            <option value="#00ff00">Grün</option>

          </select>
        </div>
      </div>-->
      <div id="menu">
        <form  id="colorPicker" autocomplete="off">
          <div class="diffuseButton"><label for="primColor">Green elements: </label><input type="color" class="primColor" value="rgba(149, 194, 61)" data-primmat="greenbake"/></div>
          <div class="diffuseButton"><label for="primColor">Dark gray elements: </label><input type="color" class="primColor" value="rgba(87, 87, 88)" data-primmat="darkgreybake"/></div>
          <div class="diffuseButton"><label for="primColor">Light gray elements: </label><input type="color" class="primColor" value="rgba(218, 218, 218)" data-primmat="lightgreybake"/></div>
        </form>
      </div>
<!--
      <div class="slider">
        <p>Metalness: <span id="metalness-value"></span></p>
        <input id="metalness" type="range" min="0" max="1" step="0.01" value="1">
      </div>
      <div class="slider">
        <p>Roughness: <span id="roughness-value"></span></p>
        <input id="roughness" type="range" min="0" max="1" step="0.01" value="0">
      </div>


      -->
      <effect-composer id="composer" render-mode="quality" msaa="6">
        <ssao-effect strength="2"></ssao-effect>
        <outline-effect strength="1" radius="0.7" threshold="0"></outline-effect>
        <color-grade-effect></color-grade-effect>
      </effect-composer>
    </model-viewer>
  </div>



  <script type="module" >
   const modelViewer = document.querySelector("#plane");
   const mv = document.querySelector("model-viewer");
   let materials;
   mv.addEventListener('model-visibility', ()=>{


    materials= modelViewer.model.materials;
    const greenMats = materials.filter(mat => mat.name && mat.name.includes("greenbake"));
    const lGreyMats = materials.filter(mat => mat.name && mat.name.includes("lightgreybake"));
    const dGreyMats = materials.filter(mat => mat.name && mat.name.includes("darkgreybake"));
    dGreyMats.forEach(mat=>{
      mat.pbrMetallicRoughness.setRoughnessFactor("0.46");
      mat.pbrMetallicRoughness.setMetallicFactor("0.12");
    });
    greenMats.forEach(mat=> mat.pbrMetallicRoughness.setBaseColorFactor('#95C23D'));
    lGreyMats.forEach(mat=> mat.pbrMetallicRoughness.setBaseColorFactor('#575758'));
    dGreyMats.forEach(mat=> mat.pbrMetallicRoughness.setBaseColorFactor('#DADADA'));
/*
    const mat0= dGreyMats[0];
    let metalnessDisplay = document.querySelector("#metalness-value");
    let roughnessDisplay = document.querySelector("#roughness-value");
    metalnessDisplay.textContent = mat0.pbrMetallicRoughness.metallicFactor;
    roughnessDisplay.textContent = mat0.pbrMetallicRoughness.roughnessFactor;

    document.querySelector('#metalness').addEventListener('input', (event) => {
      dGreyMats.forEach(mat=>{
        mat.pbrMetallicRoughness.setMetallicFactor(event.target.value);
        metalnessDisplay.textContent = event.target.value;});
    });

    document.querySelector('#roughness').addEventListener('input', (event) => {
      dGreyMats.forEach(mat=>{
        mat.pbrMetallicRoughness.setRoughnessFactor(event.target.value);
        roughnessDisplay.textContent = event.target.value;
      });
    });*/



  });
   const composer = document.querySelector("effect-composer#composer");
   const selectiveOutline = composer.querySelector("outline-effect");
   selectiveOutline.blendMode = 'skip';

   let matsToChange;



     //DISTINCT TEXTURE SETTER SELECT
   /*
   document.getElementById('diffuse').addEventListener('change', (event) => {
    const colorString = event.target.value;
    console.log(event)
    let materials = modelViewer.model.materials;
    materials.forEach(m=>console.log(m.name));
    const filtered = materials.filter(mat =>
      mat.name && mat.name.includes("greenbake")
      );
    filtered.forEach(mat=> mat.pbrMetallicRoughness.setBaseColorFactor(colorString));
  });*/

   //DISTINCT TEXTURE SETTER COLORPICKER
   document.querySelectorAll('.primColor').forEach(base=>{

    base.addEventListener('input', (event) => {
      const colorString = event.target.value;
  
      const filtered = materials.filter(mat =>
        mat.name && mat.name.includes(event.target.dataset.primmat)
        );
      filtered.forEach(mat=> mat.pbrMetallicRoughness.setBaseColorFactor(colorString));
    });

    base.addEventListener('mouseenter', (event)=>{
      let selection=[];
      composer.selection.forEach(obj=>{
        obj.material.name.includes(event.target.dataset.primmat)&&
        selection.push(obj);
      });
      selectiveOutline.selection=selection;
      selectiveOutline.blendMode = 'default';
    });

    base.addEventListener('mouseleave', (event)=>{
      selectiveOutline.blendMode = 'skip';
    });

  });



</script>


</body>
</html>